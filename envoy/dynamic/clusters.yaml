version_info: "1"
resources:
  - "@type": type.googleapis.com/envoy.config.cluster.v3.Cluster
    name: connect_go_cluster
    type: STRICT_DNS
    connect_timeout: 5s
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: connect_go_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: connect-go-boilerplate
                    port_value: 9000
              #health_status: UNHEALTHY
    # eds_cluster_config:
    #   eds_config:
    #     resource_api_version: V3
    #     path_config_source:
    #       path: "/etc/envoy/dynamic/endpoints.yaml"
    # Upstream uses HTTP/2 (gRPC)
    typed_extension_protocol_options:
      envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
        "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
        explicit_http_config:
          http2_protocol_options: {}
    # Passive outlier detection
    outlier_detection:
      consecutive_5xx: 3
      interval: 10s
      base_ejection_time: 30s
      max_ejection_percent: 50
    health_checks:
      - timeout: 2s
        interval: 5s
        unhealthy_threshold: 2
        healthy_threshold: 1
        grpc_health_check:
          service_name: "grpc.health.v1.Health"

  - "@type": type.googleapis.com/envoy.config.cluster.v3.Cluster
    name: keycloak_cluster
    type: STRICT_DNS
    connect_timeout: 5s
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: keycloak_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: keycloak
                    port_value: 8080

  - "@type": type.googleapis.com/envoy.config.cluster.v3.Cluster
    name: grafana_cluster
    type: STRICT_DNS
    connect_timeout: 5s
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: grafana_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: grafana
                    port_value: 3000

  - "@type": type.googleapis.com/envoy.config.cluster.v3.Cluster
    name: prometheus_cluster
    type: STRICT_DNS
    connect_timeout: 5s
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: prometheus_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: prometheus
                    port_value: 9090

  - "@type": type.googleapis.com/envoy.config.cluster.v3.Cluster
    name: kibana_cluster
    type: STRICT_DNS
    connect_timeout: 5s
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: kibana_cluster
      endpoints:
        - lb_endpoints:
            - endpoint:
                address:
                  socket_address:
                    address: kibana
                    port_value: 5601
